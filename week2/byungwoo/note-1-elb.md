## Scalability
- Vertical Scalability: scale-down, scale-up
    - increase instance size
    - t2.micro → t2.large
    - RDS, ElasticCache
- Horizontal Scalability: scale-in, sclae-out
    - increasing number of instances

## High Availiability

- running your application/system at least 2 data centers (=AZ)
- to survive a data centers loss
- can be passive (ex. RDS Multi AZ)
- can be active (ex. for horizontal scaling)

## Load Balancer

- servers that forward traffice to multiple servers downstream

## Why use LB?

- spread load
- expose single point of access (DNS) to your app
- handle failures of downstream intances (healthcheck)
- do regular healthchecks
- SSL termination
- stickness with cookies
- HA across zones
- seperate public traffic from private traffic

## Why use ELB?

- managed LB
- guaratees working
- upgrade, maintenance, HA
- few configuration nobs
- integrated with AWS services

## Health Checks

- port, protocol, endpoint

## Types of load balancers on AWS

- CLB: HTTP, HTTPS, TCP, SSL(secure TCP)
- ALB: HTTP, HTTPS, WebSocket
- NLB: TCP, TLS(secure TCP), UDP
- GWLB: layer 3 (Network layer) - IP Protocol
- some LB can be setup as internal(private) or external(public)

## Load Balancer SG

- Users -(HTTPS/HTTP from any)-> LB -(HTTP Restricted to LB)→ EC2

![https://dev.wisen.co.kr/uploads/2017/09/comp.png](https://dev.wisen.co.kr/uploads/2017/09/comp.png)

## CLB (v1)

- TCP(layer4), HTTP/HTTPS(layer7)
- TCP or HTTP based heathchecks
- fixed hostname: XXX.region.elb.amazonaws.com

## ALB (v2)

- Layer7(HTTP)
- multiple HTTP apps accross machines (TG)
- multiple apps on the same machine (containers)
- suppers for HTTP/2 and WebSocket
- support redirects (from HTTP to HTTPS)
- routing tables to different TG
    - path in URL (ex. /user, /posts)
    - hostname in URL (ex. one.example.com, other.example.com)
    - query string, headers
- great fit for micro services & container based apps (Docker, ECS)
- port mapping feature to redirect to dynamic port in ECS
- multiple CLB for multiple apps while one ALB for multiple apps

## ALB TG

- EC2 instances
- EC2 tasks
- Lamda functions
- IP address (only private)
- ALB can route to mutiple TG
- healthchecks are at the target group level

## ALB (Good to Know)

- fixed hostname
- true IP of client is inserted in X-Forwared-For header
- also we can get X-Forwarded-Port, X-Forwarded-Proto

## NLB (v2)

- Layer 4
- forward TCP/UDP
- handle millions of request per seconds
- 100ms latency (vs 400ms for ALB)
- one static IP per AZ
- support Elastic IP (for whitelist IP)
- for extreme performance, TCP/UDP
- not AWS free tier

## NLP TG

- EC2 instances
- IP addresses (only private)
- ALB (to expose static IP of app using NLB feature)

## GWLB

- deploy, scale, and amnage a fleed of 3rd party network virtual appliances in AWS
- ex) Firewalls, Intrusion Detection, ...
- Users → Route Table → GWLB → 3rd Party Security Virtual Appliances → Application
- Operates at Layer 3 (Network Layer) - IP Packets
- combines two functions
    - Transparent Network GW - single entry/exit for all traffic
    - Load Balancer - distribute traffic to your vitual appliances

## GWLB TG

- EC2 instances
- IP Address (private)

## Sticky Session (Session Affinity)

- same client always redirected to the same instance behind LB
- CLB & ALB
- cookie used for stickiness (with expiration date)
- to restore user session data
- may bring imbalance load over EC2

## Sticky Sessions - Cookie Names

- Application-based Cookies
    - Custom cooke
        - Generated by TG
        - custom attributes
        - cookie name must be specified by TG
        - custom cookie name (except AWSALB, AWSALBAPP, AWSALBTG)
    - Application cookie
        - Generated by LB
        - Cookie name is AWSALBAPP
- Duration-based Cookies
    - generated by LB
    - Cookie name is AWSALB(ALB), AWSELB(CLB)

## Cross-Zone Load Balancing

- with cross-zone: 1/n for instances (regardless of AZ)
- without cross-zone: 1/n for AZ
- ALB
    - always on (cannot be disabled)
    - no charges for inter AZ data
- NLB
    - disabled by default
    - charges on inter AZ data if enabled
- CLB
    - disabled by default
    - no charges for inter AZ data

## SSL/TLS

- SSL certificate allows traffic to be encrpyted
- SSL (Secure Sockets Layer)
- TLS (Transport Layer Security)
- usually SSL refers SSL/TLS
- Public SSL certificats issued by Certificate Authorities (CA)
- SSL certificates have expiration date

## Load Balancer - SSL Certificates

- Users ←(HTTPS)→ LB ←(HTTP)→ EC2
- LB uses X.509 certificate (SSL/TLS server certificate)
- manage certificate with ACM (AWS Certificate Manager)
- can upload own certificate alternatively
- HTTPS listener:
    - You must specify a default certificate
    - You can add an optional list of certs to support multiple domains
    - Clients can use SNI(Server Name Indication) to specify the hostname they reach
    - Ability to specify security policy to support older versions os SSL/TLS (legacy clients)

## SNI (Server Name Indication)

- loading muliple SSL certificate onto 1 web server (to serve multiple websites)
- ‘newer’ protocol and requires client to indicate the hostname of the target server in initial SSL handshake
- The server will them find the correct certificate or return the default one
- only works for ALB, NLB, CF (newer gen) but not CLB (older gen)

## ELB - SSL Certificates

- CLB (v1)
    - supports only one SSL certificate
    - must use multpiple CLB for multiple hostname & SSL certificates
- ALB (v2)
    - supports multiple listeners with multiple SSL certificates
    - uses SNI to make it nwork
- NLB (v2)
    - supports multiple listeners with multiple SSL certificates
    - uses SNI to make it nwork

## Connection Drainig

- = connection draining (for CLB)
- = deregetration delay (for ALB & NLB)
- time to complete in-flight requests whilte instance is de-registering or unhealthy
- stop sending new requests to EC2 in de-registering
- 1 ~ 3600s (default: 300s, disabled: 0)
- set low if your requests are short